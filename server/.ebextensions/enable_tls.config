option_settings:
  aws:elasticbeanstalk:container:nodejs:staticfiles:
    /.well-known: /.well-known

Resources:
  sslSecurityGroupIngress: 
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: {"Fn::GetAtt" : ["AWSEBSecurityGroup", "GroupId"]}
      IpProtocol: tcp
      ToPort: 443
      FromPort: 443
      CidrIp: 0.0.0.0/0

files:
  /opt/elasticbeanstalk/https.conf:
    mode: "000644"
    owner: root
    group: root
    content: |

      # HTTPS server

      server {
          listen       443;
          server_name  localhost;
          
          ssl                  on;
          ssl_certificate      /etc/letsencrypt/live/ebcert/fullchain.pem;
          ssl_certificate_key  /etc/letsencrypt/live/ebcert/privkey.pem;
          
          ssl_session_timeout  5m;
          
          ssl_protocols  TLSv1.1 TLSv1.2;
          ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
          ssl_prefer_server_ciphers   on;

          if ($time_iso8601 ~ "^(\d{4})-(\d{2})-(\d{2})T(\d{2})") {
              set $year $1;
              set $month $2;
              set $day $3;
              set $hour $4;
          }
          access_log /var/log/nginx/healthd/application.log.$year-$month-$day-$hour healthd;
          access_log  /var/log/nginx/access.log  main;
          
          location / {
              proxy_pass  http://nodejs;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection "upgrade";
              proxy_http_version 1.1;
              proxy_set_header        Host            $host;
              proxy_set_header        X-Real-IP       $remote_addr;
              proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header        X-Forwarded-Proto https;
          }
      }

  /opt/elasticbeanstalk/hooks/appdeploy/post/62_change_nginx_tls.sh:
    mode: "000755"
    owner: root
    group: root
    content: |
      echo "**** Enabling TLS ****"
      sudo mkdir -p /var/app/current/.well-known
      wget https://dl.eff.org/certbot-auto;chmod a+x certbot-auto
      sudo ./certbot-auto certonly --staging --debug --non-interactive --email me@djnicholson.com --agree-tos --webroot -w /var/app/current --domains server.blockslack.io --keep-until-expiring --pre-hook "initctl start nginx" --post-hook "initctl restart nginx"
      ln -sf /etc/letsencrypt/live/server.blockslack.io /etc/letsencrypt/live/ebcert
      sudo cat /opt/elasticbeanstalk/https.conf >> /tmp/deployment/config/#etc#nginx#conf.d#00_elastic_beanstalk_proxy.conf
      cat /tmp/deployment/config/#etc#nginx#conf.d#00_elastic_beanstalk_proxy.conf

packages: 
  yum:
    epel-release: [] 

