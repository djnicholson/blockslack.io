option_settings:
  aws:elasticbeanstalk:container:nodejs:staticfiles:
    /.well-known: /.well-known

Resources:
  sslSecurityGroupIngress: 
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: {"Fn::GetAtt" : ["AWSEBSecurityGroup", "GroupId"]}
      IpProtocol: tcp
      ToPort: 443
      FromPort: 443
      CidrIp: 0.0.0.0/0

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/62_change_nginx_tls.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      echo **** Enabling TLS ****
      sudo mkdir -p /var/app/current/.well-known
      wget https://dl.eff.org/certbot-auto;chmod a+x certbot-auto
      pwd
      sudo ./certbot-auto certonly --staging --debug --non-interactive --email me@djnicholson.com --agree-tos --webroot -w /var/app/current/.well-known --domains server.blockslack.io --keep-until-expiring --pre-hook "initctl start nginx" --post-hook "initctl restart nginx"
      cat /var/log/letsencrypt/letsencrypt.log
      ln -sf /etc/letsencrypt/live/server.blockslack.io /etc/letsencrypt/live/ebcert
      sudo sed -i '/\s*listen\s*8080/c \
              listen 443 default ssl;\
              ssl_certificate      /etc/letsencrypt/live/ebcert/fullchain.pem;\
              ssl_certificate_key  /etc/letsencrypt/live/ebcert/privkey.pem;\
              ssl_session_timeout  5m;\
              ssl_protocols  TLSv1.1 TLSv1.2;\
              ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";\
              ssl_prefer_server_ciphers   on;\
          ' /tmp/deployment/config/#etc#nginx#conf.d#00_elastic_beanstalk_proxy.conf
      echo *** Done; new file: ***
      cat /tmp/deployment/config/#etc#nginx#conf.d#00_elastic_beanstalk_proxy.conf
      echo *** End ***

packages: 
  yum:
    epel-release: [] 

